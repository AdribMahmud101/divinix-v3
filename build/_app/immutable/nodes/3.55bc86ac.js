import{s as be,b as A,k as C,h as B,o as Se,t as q}from"../chunks/scheduler.0545783f.js";import{S as ve,i as Ie,D as E,r as F,s as de,g as K,u as W,c as ue,h as Q,j as X,f as D,k as Z,v as x,a as ge,x as G,A as ke,d as $,t as ee,w as te}from"../chunks/index.3f9f9994.js";import{N as Te,M as Me,a as Pe,b as Ne,g as Oe}from"../chunks/Navbar.fac66afe.js";import{i as me,d as he,h as Ae,O as _e,t as fe,g as Ce,b as Ee,k as He}from"../chunks/Toaster.svelte_svelte_type_style_lang.c00290f2.js";import{v as se,s as we}from"../chunks/index.df24c592.js";import"../chunks/singletons.9fb19158.js";import{p as Re}from"../chunks/stores.60c9e64f.js";const{window:Je}=Oe;function Be(a){var Y;let S,s,m,g,I,e,O,T,y,d,f,H,v,M,u,l,n,j,P,z,V;S=new Te({props:{title:a[4]}});function oe(o){a[14](o)}let U={disabled:a[7].length>0};a[0]!==void 0&&(U.selectedModels=a[0]),e=new Me({props:U}),A.push(()=>E(e,"selectedModels",oe));function ne(o){a[15](o)}function ae(o){a[16](o)}function L(o){a[17](o)}let R={selectedModels:a[0],selectedModelfile:a[3],sendPrompt:a[8],regenerateResponse:a[11]};a[1]!==void 0&&(R.history=a[1]),a[7]!==void 0&&(R.messages=a[7]),a[2]!==void 0&&(R.autoScroll=a[2]),d=new Pe({props:R}),A.push(()=>E(d,"history",ne)),A.push(()=>E(d,"messages",ae)),A.push(()=>E(d,"autoScroll",L));function le(o){a[18](o)}function re(o){a[19](o)}function ie(o){a[20](o)}let J={suggestionPrompts:((Y=a[3])==null?void 0:Y.suggestionPrompts)??[{title:["Help me study","vocabulary for a college entrance exam"],content:"Help me study vocabulary: write a sentence for me to fill in the blank, and I'll try to pick the correct option."},{title:["Give me ideas","for what to do with my kids' art"],content:"What are 5 creative things I could do with my kids' art? I don't want to throw them away, but it's also so much clutter."},{title:["Tell me a fun fact","about the Roman Empire"],content:"Tell me a random fun fact about the Roman Empire"},{title:["Show me a code snippet","of a website's sticky header"],content:"Show me a code snippet of a website's sticky header in CSS and JavaScript."}],messages:a[7],submitPrompt:a[9],stopResponse:a[10]};return a[5]!==void 0&&(J.prompt=a[5]),a[6]!==void 0&&(J.files=a[6]),a[2]!==void 0&&(J.autoScroll=a[2]),u=new Ne({props:J}),A.push(()=>E(u,"prompt",le)),A.push(()=>E(u,"files",re)),A.push(()=>E(u,"autoScroll",ie)),{c(){F(S.$$.fragment),s=de(),m=K("div"),g=K("div"),I=K("div"),F(e.$$.fragment),T=de(),y=K("div"),F(d.$$.fragment),M=de(),F(u.$$.fragment),this.h()},l(o){W(S.$$.fragment,o),s=ue(o),m=Q(o,"DIV",{class:!0});var p=X(m);g=Q(p,"DIV",{class:!0});var t=X(g);I=Q(t,"DIV",{class:!0});var r=X(I);W(e.$$.fragment,r),r.forEach(D),T=ue(t),y=Q(t,"DIV",{class:!0});var i=X(y);W(d.$$.fragment,i),i.forEach(D),t.forEach(D),M=ue(p),W(u.$$.fragment,p),p.forEach(D),this.h()},h(){Z(I,"class","max-w-2xl mx-auto w-full px-3 md:px-0 mt-10"),Z(y,"class","h-full mt-10 mb-32 w-full flex flex-col"),Z(g,"class","py-2.5 flex flex-col justify-between w-full"),Z(m,"class","min-h-screen w-full flex justify-center")},m(o,p){x(S,o,p),ge(o,s,p),ge(o,m,p),G(m,g),G(g,I),x(e,I,null),G(g,T),G(g,y),x(d,y,null),G(m,M),x(u,m,null),P=!0,z||(V=ke(Je,"scroll",a[13]),z=!0)},p(o,p){var b;const t={};p[0]&16&&(t.title=o[4]),S.$set(t);const r={};p[0]&128&&(r.disabled=o[7].length>0),!O&&p[0]&1&&(O=!0,r.selectedModels=o[0],C(()=>O=!1)),e.$set(r);const i={};p[0]&1&&(i.selectedModels=o[0]),p[0]&8&&(i.selectedModelfile=o[3]),!f&&p[0]&2&&(f=!0,i.history=o[1],C(()=>f=!1)),!H&&p[0]&128&&(H=!0,i.messages=o[7],C(()=>H=!1)),!v&&p[0]&4&&(v=!0,i.autoScroll=o[2],C(()=>v=!1)),d.$set(i);const c={};p[0]&8&&(c.suggestionPrompts=((b=o[3])==null?void 0:b.suggestionPrompts)??[{title:["Help me study","vocabulary for a college entrance exam"],content:"Help me study vocabulary: write a sentence for me to fill in the blank, and I'll try to pick the correct option."},{title:["Give me ideas","for what to do with my kids' art"],content:"What are 5 creative things I could do with my kids' art? I don't want to throw them away, but it's also so much clutter."},{title:["Tell me a fun fact","about the Roman Empire"],content:"Tell me a random fun fact about the Roman Empire"},{title:["Show me a code snippet","of a website's sticky header"],content:"Show me a code snippet of a website's sticky header in CSS and JavaScript."}]),p[0]&128&&(c.messages=o[7]),!l&&p[0]&32&&(l=!0,c.prompt=o[5],C(()=>l=!1)),!n&&p[0]&64&&(n=!0,c.files=o[6],C(()=>n=!1)),!j&&p[0]&4&&(j=!0,c.autoScroll=o[2],C(()=>j=!1)),u.$set(c)},i(o){P||($(S.$$.fragment,o),$(e.$$.fragment,o),$(d.$$.fragment,o),$(u.$$.fragment,o),P=!0)},o(o){ee(S.$$.fragment,o),ee(e.$$.fragment,o),ee(d.$$.fragment,o),ee(u.$$.fragment,o),P=!1},d(o){o&&(D(s),D(m)),te(S,o),te(e),te(d),te(u),z=!1,V()}}}function De(a,S,s){let m,g,I,e,O,T;B(a,me,t=>s(22,m=t)),B(a,Ce,t=>s(23,g=t)),B(a,Ee,t=>s(24,I=t)),B(a,he,t=>s(25,e=t)),B(a,Re,t=>s(26,O=t)),B(a,He,t=>s(12,T=t));let y=!1,d=!0,f=[""],H=null,v="",M="",u=[],l=[],n={messages:{},currentId:null};Se(async()=>{await me.set(se()),me.subscribe(async()=>{await j()})});const j=async()=>{var r;console.log(m),s(2,d=!0),s(4,v=""),s(7,l=[]),s(1,n={messages:{},currentId:null}),s(0,f=O.url.searchParams.get("models")?(r=O.url.searchParams.get("models"))==null?void 0:r.split(","):e.models??[""]);let t=JSON.parse(localStorage.getItem("settings")??"{}");console.log(t),he.set({...e,...t})},P=async(t,r,i)=>{await Promise.all(f.map(async c=>{c.includes("gpt-")?await V(c,t,r,i):await z(c,t,r,i)})),await Ae.set(await g.getChats())},z=async(t,r,i,c)=>{console.log("sendPromptOllama");let b=se(),_={parentId:i,id:b,childrenIds:[],role:"assistant",content:"",model:t};s(1,n.messages[b]=_,n),s(1,n.currentId=b,n),i!==null&&s(1,n.messages[i].childrenIds=[...n.messages[i].childrenIds,b],n),await q(),window.scrollTo({top:document.body.scrollHeight});const ce=(await fetch(`${(e==null?void 0:e.API_BASE_URL)??_e}/chat`,{method:"POST",headers:{"Content-Type":"text/event-stream",...e.authHeader&&{Authorization:e.authHeader},...I&&{Authorization:`Bearer ${localStorage.token}`}},body:JSON.stringify({model:t,messages:[e.system?{role:"system",content:e.system}:void 0,...l].filter(w=>w).map(w=>({role:w.role,content:w.content})),options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},format:e.requestFormat??void 0})})).body.pipeThrough(new TextDecoderStream).pipeThrough(we(`
`)).getReader();for(;;){const{value:w,done:pe}=await ce.read();if(pe||y||c!==m){_.done=!0,s(7,l),s(1,n);break}try{let k=w.split(`
`);for(const N of k)if(N!==""){console.log(N);let h=JSON.parse(N);if("detail"in h)throw h;if(h.done==!1){if(_.content==""&&h.message.content==`
`)continue;_.content+=h.message.content,s(7,l),s(1,n)}else _.done=!0,_.context=h.context??null,_.info={total_duration:h.total_duration,prompt_eval_count:h.prompt_eval_count,prompt_eval_duration:h.prompt_eval_duration,eval_count:h.eval_count,eval_duration:h.eval_duration},s(7,l),s(1,n)}}catch(k){console.log(k),"detail"in k&&fe.error(k.detail);break}d&&window.scrollTo({top:document.body.scrollHeight}),await g.updateChatById(c,{title:v===""?"New Chat":v,models:f,system:e.system??void 0,options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},messages:l,history:n})}y=!1,await q(),d&&window.scrollTo({top:document.body.scrollHeight}),l.length==2&&l.at(1).content!==""&&(window.history.replaceState(n.state,"",`/c/${c}`),await ae(c,r))},V=async(t,r,i,c)=>{if(e.OPENAI_API_KEY&&models){let b=se(),_={parentId:i,id:b,childrenIds:[],role:"assistant",content:"",model:t};s(1,n.messages[b]=_,n),s(1,n.currentId=b,n),i!==null&&s(1,n.messages[i].childrenIds=[...n.messages[i].childrenIds,b],n),await q(),window.scrollTo({top:document.body.scrollHeight});const ce=(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.OPENAI_API_KEY}`},body:JSON.stringify({model:t,stream:!0,messages:[e.system?{role:"system",content:e.system}:void 0,...l].filter(w=>w).map(w=>({role:w.role,content:w.content})),temperature:e.temperature??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,frequency_penalty:e.repeat_penalty??void 0})})).body.pipeThrough(new TextDecoderStream).pipeThrough(we(`
`)).getReader();for(;;){const{value:w,done:pe}=await ce.read();if(pe||y||c!==m){_.done=!0,s(7,l),s(1,n);break}try{let k=w.split(`
`);for(const N of k)if(N!=="")if(console.log(N),N==="data: [DONE]")_.done=!0,s(7,l),s(1,n);else{let h=JSON.parse(N.replace(/^data: /,""));if(console.log(h),_.content==""&&h.choices[0].delta.content==`
`)continue;_.content+=h.choices[0].delta.content??"",s(7,l),s(1,n)}}catch(k){console.log(k)}d&&window.scrollTo({top:document.body.scrollHeight}),await g.updateChatById(c,{title:v===""?"New Chat":v,models:f,system:e.system??void 0,options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},messages:l,history:n})}y=!1,await q(),d&&window.scrollTo({top:document.body.scrollHeight}),l.length==2&&(window.history.replaceState(n.state,"",`/c/${c}`),await L(c,r))}},oe=async t=>{const r=JSON.parse(JSON.stringify(m));if(console.log("submitPrompt",r),f.includes(""))fe.error("Model not selected");else if(l.length!=0&&l.at(-1).done!=!0)console.log("wait");else{document.getElementById("chat-textarea").style.height="";let i=se(),c={id:i,parentId:l.length!==0?l.at(-1).id:null,childrenIds:[],role:"user",content:t,files:u.length>0?u:void 0};l.length!==0&&n.messages[l.at(-1).id].childrenIds.push(i),s(1,n.messages[i]=c,n),s(1,n.currentId=i,n),await q(),l.length==1&&await g.createNewChat({id:r,title:"New Chat",models:f,system:e.system??void 0,options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},messages:l,history:n}),s(5,M=""),s(6,u=[]),setTimeout(()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},50),await P(t,i,r)}},U=()=>{y=!0,console.log("stopResponse")},ne=async()=>{const t=JSON.parse(JSON.stringify(m));if(console.log("regenerateResponse",t),l.length!=0&&l.at(-1).done==!0){l.splice(l.length-1,1),s(7,l),s(1,n);let r=l.at(-1),i=r.content;await P(i,r.id,t)}},ae=async(t,r)=>{if(e.titleAutoGenerate??!0){console.log("generateChatTitle");const i=await fetch(`${(e==null?void 0:e.API_BASE_URL)??_e}/generate`,{method:"POST",headers:{"Content-Type":"text/event-stream",...e.authHeader&&{Authorization:e.authHeader},...I&&{Authorization:`Bearer ${localStorage.token}`}},body:JSON.stringify({model:f[0],prompt:`Generate a brief 3-5 word title for this question, excluding the term 'title.' Then, please reply with only the title: ${r}`,stream:!1})}).then(async c=>{if(!c.ok)throw await c.json();return c.json()}).catch(c=>("detail"in c&&fe.error(c.detail),console.log(c),null));i&&await L(t,i.response===""?"New Chat":i.response)}else await L(t,`${r}`)},L=async(t,r)=>{await g.updateChatById(t,{title:r}),t===m&&s(4,v=r)},R=t=>{s(2,d=window.innerHeight+window.scrollY>=document.body.offsetHeight-40)};function le(t){f=t,s(0,f)}function re(t){n=t,s(1,n)}function ie(t){l=t,s(7,l),s(1,n)}function J(t){d=t,s(2,d)}function Y(t){M=t,s(5,M)}function o(t){u=t,s(6,u)}function p(t){d=t,s(2,d)}return a.$$.update=()=>{if(a.$$.dirty[0]&4097&&s(3,H=f.length===1&&T.filter(t=>t.tagName===f[0]).length>0?T.filter(t=>t.tagName===f[0])[0]:null),a.$$.dirty[0]&2)if(n.currentId!==null){let t=[],r=n.messages[n.currentId];for(;r!==null;)t.unshift({...r}),r=r.parentId!==null?n.messages[r.parentId]:null;s(7,l=t)}else s(7,l=[])},[f,n,d,H,v,M,u,l,P,oe,U,ne,T,R,le,re,ie,J,Y,o,p]}class Ye extends ve{constructor(S){super(),Ie(this,S,De,Be,be,{},null,[-1,-1])}}export{Ye as component};
