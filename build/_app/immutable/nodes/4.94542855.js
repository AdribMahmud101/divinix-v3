import{s as ve,h as q,b as G,k as V,t as H}from"../chunks/scheduler.0545783f.js";import{S as ke,i as Ie,e as ge,a as fe,A as Te,d as D,t as Y,b as Me,f as J,D as U,r as W,s as pe,g as Q,u as X,c as de,h as Z,j as x,k as $,v as ee,x as F,w as te,p as Ne}from"../chunks/index.3f9f9994.js";import{g as Pe,N as Ae,M as Ce,a as Oe,b as He}from"../chunks/Navbar.fac66afe.js";import{h as Ee,O as he,t as me,i as _e,g as Re,b as Be,d as we,k as Je}from"../chunks/Toaster.svelte_svelte_type_style_lang.c00290f2.js";import{v as ue,s as ye,b as De}from"../chunks/index.df24c592.js";import{g as je}from"../chunks/navigation.0331cceb.js";import{p as ze}from"../chunks/stores.60c9e64f.js";const{window:Le}=Pe;function be(a){var K;let f,o,m,u,r,e,b,A,T,g,_,h,j,k,w,E,l,s;f=new Ae({props:{title:a[5]}});function oe(n){a[15](n)}let z={disabled:a[7].length>0};a[0]!==void 0&&(z.selectedModels=a[0]),e=new Ce({props:z}),G.push(()=>U(e,"selectedModels",oe));function se(n){a[16](n)}function ne(n){a[17](n)}function ae(n){a[18](n)}let L={selectedModels:a[0],selectedModelfile:a[4],sendPrompt:a[8],regenerateResponse:a[11]};a[1]!==void 0&&(L.history=a[1]),a[7]!==void 0&&(L.messages=a[7]),a[3]!==void 0&&(L.autoScroll=a[3]),g=new Oe({props:L}),G.push(()=>U(g,"history",se)),G.push(()=>U(g,"messages",ne)),G.push(()=>U(g,"autoScroll",ae));function le(n){a[19](n)}function re(n){a[20](n)}let R={suggestionPrompts:((K=a[4])==null?void 0:K.suggestionPrompts)??[{title:["Help me study","vocabulary for a college entrance exam"],content:"Help me study vocabulary: write a sentence for me to fill in the blank, and I'll try to pick the correct option."},{title:["Give me ideas","for what to do with my kids' art"],content:"What are 5 creative things I could do with my kids' art? I don't want to throw them away, but it's also so much clutter."},{title:["Tell me a fun fact","about the Roman Empire"],content:"Tell me a random fun fact about the Roman Empire"},{title:["Show me a code snippet","of a website's sticky header"],content:"Show me a code snippet of a website's sticky header in CSS and JavaScript."}],messages:a[7],submitPrompt:a[9],stopResponse:a[10]};return a[6]!==void 0&&(R.prompt=a[6]),a[3]!==void 0&&(R.autoScroll=a[3]),w=new He({props:R}),G.push(()=>U(w,"prompt",le)),G.push(()=>U(w,"autoScroll",re)),{c(){W(f.$$.fragment),o=pe(),m=Q("div"),u=Q("div"),r=Q("div"),W(e.$$.fragment),A=pe(),T=Q("div"),W(g.$$.fragment),k=pe(),W(w.$$.fragment),this.h()},l(n){X(f.$$.fragment,n),o=de(n),m=Z(n,"DIV",{class:!0});var p=x(m);u=Z(p,"DIV",{class:!0});var M=x(u);r=Z(M,"DIV",{class:!0});var C=x(r);X(e.$$.fragment,C),C.forEach(J),A=de(M),T=Z(M,"DIV",{class:!0});var I=x(T);X(g.$$.fragment,I),I.forEach(J),M.forEach(J),k=de(p),X(w.$$.fragment,p),p.forEach(J),this.h()},h(){$(r,"class","max-w-2xl mx-auto w-full px-3 md:px-0 mt-10"),$(T,"class","h-full mt-10 mb-32 w-full flex flex-col"),$(u,"class","py-2.5 flex flex-col justify-between w-full"),$(m,"class","min-h-screen w-full flex justify-center")},m(n,p){ee(f,n,p),fe(n,o,p),fe(n,m,p),F(m,u),F(u,r),ee(e,r,null),F(u,A),F(u,T),ee(g,T,null),F(m,k),ee(w,m,null),s=!0},p(n,p){var t;const M={};p[0]&32&&(M.title=n[5]),f.$set(M);const C={};p[0]&128&&(C.disabled=n[7].length>0),!b&&p[0]&1&&(b=!0,C.selectedModels=n[0],V(()=>b=!1)),e.$set(C);const I={};p[0]&1&&(I.selectedModels=n[0]),p[0]&16&&(I.selectedModelfile=n[4]),!_&&p[0]&2&&(_=!0,I.history=n[1],V(()=>_=!1)),!h&&p[0]&128&&(h=!0,I.messages=n[7],V(()=>h=!1)),!j&&p[0]&8&&(j=!0,I.autoScroll=n[3],V(()=>j=!1)),g.$set(I);const B={};p[0]&16&&(B.suggestionPrompts=((t=n[4])==null?void 0:t.suggestionPrompts)??[{title:["Help me study","vocabulary for a college entrance exam"],content:"Help me study vocabulary: write a sentence for me to fill in the blank, and I'll try to pick the correct option."},{title:["Give me ideas","for what to do with my kids' art"],content:"What are 5 creative things I could do with my kids' art? I don't want to throw them away, but it's also so much clutter."},{title:["Tell me a fun fact","about the Roman Empire"],content:"Tell me a random fun fact about the Roman Empire"},{title:["Show me a code snippet","of a website's sticky header"],content:"Show me a code snippet of a website's sticky header in CSS and JavaScript."}]),p[0]&128&&(B.messages=n[7]),!E&&p[0]&64&&(E=!0,B.prompt=n[6],V(()=>E=!1)),!l&&p[0]&8&&(l=!0,B.autoScroll=n[3],V(()=>l=!1)),w.$set(B)},i(n){s||(D(f.$$.fragment,n),D(e.$$.fragment,n),D(g.$$.fragment,n),D(w.$$.fragment,n),s=!0)},o(n){Y(f.$$.fragment,n),Y(e.$$.fragment,n),Y(g.$$.fragment,n),Y(w.$$.fragment,n),s=!1},d(n){n&&(J(o),J(m)),te(f,n),te(e),te(g),te(w)}}}function qe(a){let f,o,m,u,r=a[2]&&be(a);return{c(){r&&r.c(),f=ge()},l(e){r&&r.l(e),f=ge()},m(e,b){r&&r.m(e,b),fe(e,f,b),o=!0,m||(u=Te(Le,"scroll",a[14]),m=!0)},p(e,b){e[2]?r?(r.p(e,b),b[0]&4&&D(r,1)):(r=be(e),r.c(),D(r,1),r.m(f.parentNode,f)):r&&(Ne(),Y(r,1,1,()=>{r=null}),Me())},i(e){o||(D(r),o=!0)},o(e){Y(r),o=!1},d(e){e&&J(f),r&&r.d(e),m=!1,u()}}}function Ge(a,f,o){let m,u,r,e,b,A;q(a,_e,t=>o(23,m=t)),q(a,Re,t=>o(24,u=t)),q(a,Be,t=>o(25,r=t)),q(a,we,t=>o(26,e=t)),q(a,ze,t=>o(12,b=t)),q(a,Je,t=>o(13,A=t));let T=!1,g=!1,_=!0,h=[""],j=null,k="",w="",E=[],l=[],s={messages:{},currentId:null};const oe=async()=>{await _e.set(b.params.id);const t=await u.getChatById(m);return t?(console.log(t),o(0,h=((t==null?void 0:t.models)??void 0)!==void 0?t.models:[t.model??""]),o(1,s=((t==null?void 0:t.history)??void 0)!==void 0?t.history:De(t.messages)),o(5,k=t.title),await we.set({...e,system:t.system??e.system,options:t.options??e.options}),o(3,_=!0),await H(),l.length>0&&o(1,s.messages[l.at(-1).id].done=!0,s),await H(),t):null},z=async(t,i,c)=>{await Promise.all(h.map(async d=>{d.includes("gpt-")?await ne(d,t,i,c):await se(d,t,i,c)})),await Ee.set(await u.getChats())},se=async(t,i,c,d)=>{console.log("sendPromptOllama");let N=ue(),S={parentId:c,id:N,childrenIds:[],role:"assistant",content:"",model:t};o(1,s.messages[N]=S,s),o(1,s.currentId=N,s),c!==null&&o(1,s.messages[c].childrenIds=[...s.messages[c].childrenIds,N],s),await H(),window.scrollTo({top:document.body.scrollHeight});const ie=(await fetch(`${(e==null?void 0:e.API_BASE_URL)??he}/chat`,{method:"POST",headers:{"Content-Type":"text/event-stream",...e.authHeader&&{Authorization:e.authHeader},...r&&{Authorization:`Bearer ${localStorage.token}`}},body:JSON.stringify({model:t,messages:[e.system?{role:"system",content:e.system}:void 0,...l].filter(v=>v).map(v=>({role:v.role,content:v.content})),options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},format:e.requestFormat??void 0})})).body.pipeThrough(new TextDecoderStream).pipeThrough(ye(`
`)).getReader();for(;;){const{value:v,done:ce}=await ie.read();if(ce||g||d!==m){S.done=!0,o(7,l),o(1,s);break}try{let P=v.split(`
`);for(const O of P)if(O!==""){console.log(O);let y=JSON.parse(O);if("detail"in y)throw y;if(y.done==!1){if(S.content==""&&y.message.content==`
`)continue;S.content+=y.message.content,o(7,l),o(1,s)}else S.done=!0,S.context=y.context??null,S.info={total_duration:y.total_duration,prompt_eval_count:y.prompt_eval_count,prompt_eval_duration:y.prompt_eval_duration,eval_count:y.eval_count,eval_duration:y.eval_duration},o(7,l),o(1,s)}}catch(P){console.log(P),"detail"in P&&me.error(P.detail);break}_&&window.scrollTo({top:document.body.scrollHeight}),await u.updateChatById(d,{title:k===""?"New Chat":k,models:h,system:e.system??void 0,options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},messages:l,history:s})}g=!1,await H(),_&&window.scrollTo({top:document.body.scrollHeight}),l.length==2&&l.at(1).content!==""&&(window.history.replaceState(s.state,"",`/c/${d}`),await re(d,i))},ne=async(t,i,c,d)=>{if(e.OPENAI_API_KEY&&models){let N=ue(),S={parentId:c,id:N,childrenIds:[],role:"assistant",content:"",model:t};o(1,s.messages[N]=S,s),o(1,s.currentId=N,s),c!==null&&o(1,s.messages[c].childrenIds=[...s.messages[c].childrenIds,N],s),await H(),window.scrollTo({top:document.body.scrollHeight});const ie=(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.OPENAI_API_KEY}`},body:JSON.stringify({model:t,stream:!0,messages:[e.system?{role:"system",content:e.system}:void 0,...l].filter(v=>v).map(v=>({role:v.role,content:v.content})),temperature:e.temperature??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,frequency_penalty:e.repeat_penalty??void 0})})).body.pipeThrough(new TextDecoderStream).pipeThrough(ye(`
`)).getReader();for(;;){const{value:v,done:ce}=await ie.read();if(ce||g){g&&(S.done=!0,o(7,l),o(1,s));break}try{let P=v.split(`
`);for(const O of P)if(O!=="")if(console.log(O),O==="data: [DONE]")S.done=!0,o(7,l),o(1,s);else{let y=JSON.parse(O.replace(/^data: /,""));if(console.log(y),S.content==""&&y.choices[0].delta.content==`
`)continue;S.content+=y.choices[0].delta.content??"",o(7,l),o(1,s)}}catch(P){console.log(P)}_&&window.scrollTo({top:document.body.scrollHeight}),await u.updateChatById(d,{title:k===""?"New Chat":k,models:h,system:e.system??void 0,options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},messages:l,history:s})}g=!1,await H(),_&&window.scrollTo({top:document.body.scrollHeight}),l.length==2&&(window.history.replaceState(s.state,"",`/c/${d}`),await R(d,i))}},ae=async t=>{const i=JSON.parse(JSON.stringify(m));if(console.log("submitPrompt",i),h.includes(""))me.error("Model not selected");else if(l.length!=0&&l.at(-1).done!=!0)console.log("wait");else{document.getElementById("chat-textarea").style.height="";let c=ue(),d={id:c,parentId:l.length!==0?l.at(-1).id:null,childrenIds:[],role:"user",content:t,files:E.length>0?E:void 0};l.length!==0&&s.messages[l.at(-1).id].childrenIds.push(c),o(1,s.messages[c]=d,s),o(1,s.currentId=c,s),await H(),l.length==1&&await u.createNewChat({id:i,title:"New Chat",models:h,system:e.system??void 0,options:{seed:e.seed??void 0,temperature:e.temperature??void 0,repeat_penalty:e.repeat_penalty??void 0,top_k:e.top_k??void 0,top_p:e.top_p??void 0,num_ctx:e.num_ctx??void 0,...e.options??{}},messages:l,history:s}),o(6,w=""),E=[],setTimeout(()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},50),await z(t,c,i)}},L=()=>{g=!0,console.log("stopResponse")},le=async()=>{const t=JSON.parse(JSON.stringify(m));if(console.log("regenerateResponse",t),l.length!=0&&l.at(-1).done==!0){l.splice(l.length-1,1),o(7,l),o(1,s);let i=l.at(-1),c=i.content;await z(c,i.id,t)}},re=async(t,i)=>{if(e.titleAutoGenerate??!0){console.log("generateChatTitle");const c=await fetch(`${(e==null?void 0:e.API_BASE_URL)??he}/generate`,{method:"POST",headers:{"Content-Type":"text/event-stream",...e.authHeader&&{Authorization:e.authHeader},...r&&{Authorization:`Bearer ${localStorage.token}`}},body:JSON.stringify({model:h[0],prompt:`Generate a brief 3-5 word title for this question, excluding the term 'title.' Then, please reply with only the title: ${i}`,stream:!1})}).then(async d=>{if(!d.ok)throw await d.json();return d.json()}).catch(d=>("detail"in d&&me.error(d.detail),console.log(d),null));c&&await R(t,c.response===""?"New Chat":c.response)}else await R(t,`${i}`)},R=async(t,i)=>{await u.updateChatById(t,{title:i}),t===m&&o(5,k=i)},K=t=>{o(3,_=window.innerHeight+window.scrollY>=document.body.offsetHeight-40)};function n(t){h=t,o(0,h)}function p(t){s=t,o(1,s)}function M(t){l=t,o(7,l),o(1,s)}function C(t){_=t,o(3,_)}function I(t){w=t,o(6,w)}function B(t){_=t,o(3,_)}return a.$$.update=()=>{if(a.$$.dirty[0]&8193&&o(4,j=h.length===1&&A.filter(t=>t.tagName===h[0]).length>0?A.filter(t=>t.tagName===h[0])[0]:null),a.$$.dirty[0]&2)if(s.currentId!==null){let t=[],i=s.messages[s.currentId];for(;i!==null;)t.unshift({...i}),i=i.parentId!==null?s.messages[i.parentId]:null;o(7,l=t)}else o(7,l=[]);a.$$.dirty[0]&4096&&b.params.id&&(async()=>{let t=await oe();await H(),t?o(2,T=!0):await je("/")})()},[h,s,T,_,j,k,w,l,z,ae,L,le,b,A,K,n,p,M,C,I,B]}class Xe extends ke{constructor(f){super(),Ie(this,f,Ge,qe,ve,{},null,[-1,-1])}}export{Xe as component};
